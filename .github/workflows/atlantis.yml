name: Atlantis

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]
  push:
    branches:
      - main
      - master

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

jobs:
  atlantis:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.0.0

    - name: Setup Atlantis
      uses: runatlantis/atlantis-action@v1
      with:
        atlantis-version: v0.22.3
        github-token: ${{ secrets.GITHUB_TOKEN }}
        atlantis-url: ${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}
        comment-not-allowed-commands-text: |
          You're not allowed to run this command.
        allow-commands: plan,apply,unlock,approve_policies,version,help
        allow-repos: ${{ github.repository }}
        repo-allowlist: ${{ github.repository }}
        repo-config: |
          repos:
          - id: ${{ github.repository }}
            allowed_overrides: [workflow]
            allow_custom_workflows: true
            workflow: custom
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
        TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
